import React, { useState, useEffect, useRef } from 'react';
import { 
  Play, Pause, Square, Anchor, CloudRain, CloudLightning, Sun, CloudFog, 
  Zap, Search, Wind, Moon, Sunrise, ShieldAlert, LifeBuoy, Cloud, Waves, 
  Menu, X, Volume2, VolumeX, Hammer, Settings 
} from 'lucide-react';

// --- AUDIO ENGINE ---
class AmbientSynth {
  constructor() {
    this.ctx = null;
    this.nodes = [];
    this.isPlaying = false;
  }

  init() {
    if (!this.ctx) {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  stop() {
    this.nodes.forEach(n => {
      try { n.stop(); n.disconnect(); } catch(e){}
    });
    this.nodes = [];
    this.isPlaying = false;
  }

  play(type) {
    this.init();
    this.stop();
    if (this.ctx.state === 'suspended') this.ctx.resume();
    this.isPlaying = true;

    const ctx = this.ctx;
    const bufferSize = 2 * ctx.sampleRate;
    const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
    const data = buffer.getChannelData(0);

    for (let i = 0; i < bufferSize; i++) {
      data[i] = Math.random() * 2 - 1;
    }

    const noise = ctx.createBufferSource();
    noise.buffer = buffer;
    noise.loop = true;

    const gain = ctx.createGain();
    const filter = ctx.createBiquadFilter();

    if (type === 'waves') {
      filter.type = 'lowpass';
      filter.frequency.value = 400;
      gain.gain.value = 0.15;
      const lfo = ctx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.value = 0.1; 
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 300;
      lfo.connect(lfoGain);
      lfoGain.connect(filter.frequency);
      lfo.start();
      this.nodes.push(lfo);
    } 
    else if (type === 'engine') {
      filter.type = 'lowpass';
      filter.frequency.value = 120;
      gain.gain.value = 0.25;
    }
    else if (type === 'rain') {
      filter.type = 'lowpass';
      filter.frequency.value = 800;
      gain.gain.value = 0.1;
    }
    else if (type === 'underwater') {
      filter.type = 'lowpass';
      filter.frequency.value = 200;
      filter.Q.value = 10;
      gain.gain.value = 0.3;
    }
    else if (type === 'wind') {
      filter.type = 'bandpass';
      filter.frequency.value = 600;
      filter.Q.value = 1;
      gain.gain.value = 0.1;
      const lfo = ctx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.value = 0.2; 
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 200; 
      lfo.connect(lfoGain);
      lfoGain.connect(filter.frequency);
      lfo.start();
      this.nodes.push(lfo);
    }

    noise.connect(filter);
    filter.connect(gain);
    gain.connect(ctx.destination);
    noise.start();
    this.nodes.push(noise);
  }
}

// --- DATA ---
const AMBIENT_SOUNDS = [
  { id: 'mute', label: 'Mute (Silent)', icon: <VolumeX size={14}/> },
  { id: 'waves', label: 'Ocean Waves', icon: <Waves size={14}/> },
  { id: 'engine', label: 'Ship Engine', icon: <Settings size={14}/> },
  { id: 'rain', label: 'Rain on Deck', icon: <CloudRain size={14}/> },
  { id: 'underwater', label: 'Underwater', icon: <Anchor size={14}/> },
  { id: 'wind', label: 'Sea Breeze', icon: <Wind size={14}/> },
];

const THEMES = [
  { id: 'MARINE', label: 'Marine Engineering', icon: <Anchor size={16}/>, color: 'text-cyan-400' },
  { id: 'CIVIL', label: 'Civil Engineering', icon: <Hammer size={16}/>, color: 'text-orange-400' },
  { id: 'MECH', label: 'Mechanical Eng.', icon: <Settings size={16}/>, color: 'text-red-400' },
];

const FACT_DATABASE = [
  "Tekanan hidrostatik bertambah 1 atm setiap kedalaman 10 meter.",
  "Sistem DP (Dynamic Positioning) menjaga posisi kapal tanpa jangkar.",
  "Pipa bawah laut dilapisi beton (Concrete Weight Coating) agar stabil.",
  "Las Hyperbaric dilakukan di habitat kering di dasar laut.",
  "ROV Work Class memiliki tenaga hingga 200 HP hidrolik.",
  "Palung Mariana sedalam 10.994 meter.",
  "Stinger menjaga kelengkungan pipa agar tidak buckling saat instalasi.",
  "Anoda korban mencegah korosi pada kaki jacket platform.",
  "Kapal 'Pioneering Spirit' adalah kapal konstruksi terbesar di dunia.",
  "Jalur pipa Nord Stream terdiri dari 100.000 ruas pipa.",
  "Teknologi 'S-Lay' membentuk kurva S, 'J-Lay' membentuk kurva J.",
  "Free Span pada pipa berbahaya karena getaran arus laut."
];

const MODES = {
  WORK: { id: 'WORK', label: 'INSTALLATION', color: 'text-amber-500' },
  SHORT_BREAK: { id: 'SHORT_BREAK', label: 'INSPECTION', color: 'text-cyan-400', defaultTime: 5 * 60 },
  LONG_BREAK: { id: 'LONG_BREAK', label: 'DOCKING', color: 'text-emerald-400', defaultTime: 15 * 60 }
};

const DURATION_OPTIONS = [
  { id: 10, label: '10m (RAPID)', wake: 'high' },
  { id: 15, label: '15m (EXPRESS)', wake: 'medium' },
  { id: 25, label: '25m (STD)', wake: 'low' },
];

// --- SISTEM CUACA (LENGKAP) ---
const WEATHERS = {
  SUNNY: { id: 'SUNNY', label: 'CLEAR SKY', icon: <Sun size={16} className="text-yellow-400" />, bg: 'bg-gradient-to-b from-sky-400 via-sky-300 to-sky-100', sea: 'bg-cyan-600/30', overlay: 'opacity-0' },
  OVERCAST: { id: 'OVERCAST', label: 'OVERCAST', icon: <Cloud size={16} className="text-slate-200" />, bg: 'bg-gradient-to-b from-slate-400 to-slate-300', sea: 'bg-slate-700/40', overlay: 'opacity-10 bg-slate-500' },
  RAINY: { id: 'RAINY', label: 'LIGHT RAIN', icon: <CloudRain size={16} className="text-blue-300" />, bg: 'bg-gradient-to-b from-slate-600 to-slate-800', sea: 'bg-slate-800/50', overlay: 'opacity-30 bg-slate-800' },
  WINDY: { id: 'WINDY', label: 'HIGH WINDS', icon: <Wind size={16} className="text-slate-100" />, bg: 'bg-gradient-to-b from-sky-600 to-slate-500', sea: 'bg-cyan-800/60', overlay: 'opacity-0' },
  FOGGY: { id: 'FOGGY', label: 'HEAVY FOG', icon: <CloudFog size={16} className="text-slate-300" />, bg: 'bg-gradient-to-b from-slate-300 to-slate-400', sea: 'bg-slate-600/50', overlay: 'opacity-80 bg-white mix-blend-overlay' },
  SUNSET: { id: 'SUNSET', label: 'SUNSET', icon: <Sunrise size={16} className="text-orange-500" />, bg: 'bg-gradient-to-b from-indigo-800 via-purple-600 to-orange-400', sea: 'bg-purple-900/40', overlay: 'opacity-20 bg-orange-900 mix-blend-overlay' },
  NIGHT: { id: 'NIGHT', label: 'NIGHT OPS', icon: <Moon size={16} className="text-yellow-100" />, bg: 'bg-gradient-to-b from-black via-slate-900 to-slate-800', sea: 'bg-black/60', overlay: 'opacity-60 bg-black' },
  STORMY: { id: 'STORMY', label: 'STORM SURGE', icon: <CloudLightning size={16} className="text-purple-400" />, bg: 'bg-gradient-to-b from-indigo-950 to-black', sea: 'bg-indigo-950/80', overlay: 'opacity-70 bg-black' },
};

// --- MAIN COMPONENT ---
export default function PipelineMaster() {
  const [currentTheme, setCurrentTheme] = useState('MARINE');
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  
  const [mode, setMode] = useState('WORK');
  const [selectedWorkDuration, setSelectedWorkDuration] = useState(25);
  const [timeLeft, setTimeLeft] = useState(25 * 60);
  const [totalTime, setTotalTime] = useState(25 * 60);
  const [isActive, setIsActive] = useState(false);
  const [currentSound, setCurrentSound] = useState('mute');
  const [fact, setFact] = useState(FACT_DATABASE[0]);
  const [weather, setWeather] = useState(WEATHERS.SUNNY);
  
  // Visual States
  const [tideLevel, setTideLevel] = useState(0);
  const [wavePath, setWavePath] = useState("");
  const [shipYOffset, setShipYOffset] = useState(0);
  const [randomEvent, setRandomEvent] = useState(null); // 'BUOY', 'POLICE'
  
  // Buoy System
  const [buoyState, setBuoyState] = useState({
    active: false,
    x: 120, // Start off-screen right
    yOffset: 0,
    type: 'GREEN' // GREEN, RED, YELLOW
  });
  
  const audioSynth = useRef(new AmbientSynth());
  const timerRef = useRef(null);
  const weatherTimerRef = useRef(null);
  const eventTimerRef = useRef(null);

  const [visualProgress, setVisualProgress] = useState(0);

  // --- LOGIC ---

  useEffect(() => {
    if (isActive && timeLeft > 0) {
      timerRef.current = setInterval(() => {
        setTimeLeft((prev) => prev - 1);
      }, 1000);
    } else if (timeLeft === 0) {
      clearInterval(timerRef.current);
      setIsActive(false);
      audioSynth.current.stop();
      if (mode === 'WORK') switchMode('SHORT_BREAK');
    }
    return () => clearInterval(timerRef.current);
  }, [isActive, timeLeft, mode]);

  useEffect(() => {
    if (isActive) {
      weatherTimerRef.current = setInterval(() => {
        const keys = Object.keys(WEATHERS);
        const randKey = keys[Math.floor(Math.random() * keys.length)];
        setWeather(WEATHERS[randKey]);
      }, 30000); 
    }
    return () => clearInterval(weatherTimerRef.current);
  }, [isActive]);

  // Event Timer
  useEffect(() => {
    if (isActive) {
      eventTimerRef.current = setInterval(() => {
        if (Math.random() < 0.3) {
          const events = ['POLICE']; // Only police is strictly an event, buoy is always active loop
          // But to comply with request variation, we trigger police occasionally
          setRandomEvent('POLICE');
          setTimeout(() => setRandomEvent(null), 25000);
        }
      }, 45000);
    }
    return () => clearInterval(eventTimerRef.current);
  }, [isActive]);

  // Main Animation Loop
  useEffect(() => {
    let animationFrame;
    const updateVisuals = () => {
      // 1. Smooth Progress Interpolation
      const targetProgress = Math.max(0, Math.min(100, ((totalTime - timeLeft) / totalTime) * 100));
      setVisualProgress(prev => {
        const diff = targetProgress - prev;
        if (Math.abs(diff) < 0.01) return targetProgress;
        return prev + diff * 0.05;
      });

      // 2. Tide Physics (Extreme)
      const tideTime = Date.now() / 3000;
      const tide = Math.sin(tideTime) * 10; 
      setTideLevel(tide);

      // 3. Wave Geometry
      const time = Date.now() / 1000;
      const wavePoints = [];
      const waveAmp = 1.5;
      const waveFreq = 0.1;
      const waveSpeed = 2;
      
      for (let x = 0; x <= 100; x++) {
        const y = Math.sin((x * waveFreq) + (time * waveSpeed)) * waveAmp;
        wavePoints.push([x, y]);
      }

      const pathD = `M 0,${wavePoints[0][1]} ` + 
                    wavePoints.map(p => `L ${p[0]},${p[1]}`).join(" ") + 
                    ` L 100,50 L 0,50 Z`;
      setWavePath(pathD);

      // 4. Ship Physics
      const shipStart = 10; 
      const shipEnd = 85;
      const currentShipX = shipStart + (visualProgress / 100) * (shipEnd - shipStart);
      const shipWaveY = Math.sin((currentShipX * waveFreq) + (time * waveSpeed)) * waveAmp;
      setShipYOffset(shipWaveY);

      // 5. Buoy Logic
      setBuoyState(prev => {
        // Drift buoy from right (120) to left (-20)
        let newX = prev.x - 0.1; // Speed of drift
        let newType = prev.type;
        
        // Reset if off-screen left
        if (newX < -20) {
          newX = 120;
          // Randomize Type
          const types = ['GREEN', 'RED', 'YELLOW'];
          newType = types[Math.floor(Math.random() * types.length)];
        }

        // Calculate Y float
        const buoyWaveY = Math.sin((newX * waveFreq) + (time * waveSpeed)) * waveAmp;
        return { active: true, x: newX, yOffset: buoyWaveY, type: newType };
      });

      animationFrame = requestAnimationFrame(updateVisuals);
    };
    
    animationFrame = requestAnimationFrame(updateVisuals);
    return () => cancelAnimationFrame(animationFrame);
  }, [isActive, timeLeft, totalTime, visualProgress]);

  useEffect(() => {
    if (isActive && currentSound !== 'mute') {
      audioSynth.current.play(currentSound);
    } else {
      audioSynth.current.stop();
    }
    return () => audioSynth.current.stop();
  }, [isActive, currentSound]);

  const switchMode = (newModeId) => {
    const newMode = MODES[newModeId];
    setMode(newModeId);
    let duration = newModeId === 'WORK' ? selectedWorkDuration * 60 : newMode.defaultTime;
    setTotalTime(duration);
    setTimeLeft(duration);
    setIsActive(false);
    setFact(FACT_DATABASE[Math.floor(Math.random() * FACT_DATABASE.length)]);
    setWeather(WEATHERS.SUNNY);
  };

  const toggleTimer = () => setIsActive(!isActive);
  const resetTimer = () => {
    if(window.confirm("Abort Mission?")) switchMode(mode);
  }

  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
  };

  const renderMenu = () => (
    <div className={`absolute top-0 right-0 z-50 bg-slate-900 border-l border-slate-700 h-full w-64 shadow-2xl transform transition-transform duration-300 ${isMenuOpen ? 'translate-x-0' : 'translate-x-full'}`}>
      <div className="p-4 flex justify-between items-center border-b border-slate-800">
        <h2 className="font-bold text-white">SYSTEM CONFIG</h2>
        <button onClick={() => setIsMenuOpen(false)}><X className="text-slate-400 hover:text-white"/></button>
      </div>
      
      <div className="p-4 space-y-6">
        <div>
          <h3 className="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Department Theme</h3>
          <div className="space-y-2">
            {THEMES.map(theme => (
              <button 
                key={theme.id}
                onClick={() => { setCurrentTheme(theme.id); setIsMenuOpen(false); }}
                className={`w-full flex items-center gap-3 p-3 rounded text-sm font-bold transition-all ${currentTheme === theme.id ? 'bg-slate-800 text-white border border-slate-600' : 'text-slate-400 hover:bg-slate-800/50'}`}
              >
                <span className={theme.color}>{theme.icon}</span>
                {theme.label}
              </button>
            ))}
          </div>
        </div>

        <div>
          <h3 className="text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Ambient Audio</h3>
          <div className="space-y-1">
            {AMBIENT_SOUNDS.map(sound => (
              <button
                key={sound.id}
                onClick={() => setCurrentSound(sound.id)}
                className={`w-full flex items-center gap-2 p-2 rounded text-xs font-mono transition-all ${currentSound === sound.id ? 'bg-cyan-900/30 text-cyan-400 border border-cyan-800' : 'text-slate-400 hover:bg-slate-800'}`}
              >
                {sound.icon} {sound.label}
              </button>
            ))}
          </div>
        </div>
      </div>
    </div>
  );

  const renderWeatherEffects = () => {
    return (
      <div className="absolute inset-0 z-30 pointer-events-none">
        {weather.id === 'RAINY' && (
          <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-60 animate-slide-down mix-blend-screen"></div>
        )}
        {weather.id === 'STORMY' && (
          <>
            <div className="absolute inset-0 bg-black/40"></div>
            <div className="absolute inset-0 animate-lightning bg-white/20 opacity-0"></div>
            <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-80 animate-slide-down mix-blend-screen" style={{ animationDuration: '0.5s' }}></div>
          </>
        )}
        {weather.id === 'FOGGY' && (
          <div className="absolute inset-0 bg-white/10 backdrop-blur-[2px] animate-pulse"></div>
        )}
        {weather.id === 'SUNNY' && (
          <div className="absolute top-0 right-0 w-64 h-64 bg-yellow-400/20 rounded-full blur-[100px] animate-pulse"></div>
        )}
      </div>
    );
  }

  // --- BUOY COMPONENT ---
  const renderBuoy = () => {
    if (!buoyState.active) return null;
    
    // Posisi Buoy (Z-INDEX 15: Behind Ship Z-30)
    // Base Top: Sea Level - 2%
    const MSL = 45; 
    const currentWaterY = MSL - tideLevel;
    const finalBuoyTop = currentWaterY - 2 + buoyState.yOffset;

    let BuoyShape = null;
    
    // Buoy Designs (SVG)
    if (buoyState.type === 'GREEN') {
      // Port Side (Can Shape)
      BuoyShape = (
        <div className="relative flex flex-col items-center origin-bottom">
           {/* Light */}
           <div className="w-2 h-2 bg-green-400 rounded-full animate-ping mb-1 shadow-[0_0_10px_#4ade80]"></div>
           {/* Can Body */}
           <div className="w-6 h-8 bg-green-700 border-r-2 border-b-2 border-green-900 flex items-center justify-center">
             <div className="w-4 h-6 border-2 border-green-500/30"></div>
           </div>
           <div className="w-8 h-2 bg-green-900 rounded-b-md"></div>
        </div>
      );
    } else if (buoyState.type === 'RED') {
      // Starboard (Cone Shape)
      BuoyShape = (
        <div className="relative flex flex-col items-center origin-bottom">
           <div className="w-2 h-2 bg-red-500 rounded-full animate-ping mb-1 shadow-[0_0_10px_#ef4444]"></div>
           {/* Cone Body */}
           <div className="w-0 h-0 border-l-[12px] border-r-[12px] border-b-[24px] border-l-transparent border-r-transparent border-b-red-700"></div>
           <div className="w-8 h-3 bg-red-800 rounded-b-md"></div>
        </div>
      );
    } else {
      // Special Mark (Yellow Sphere)
      BuoyShape = (
        <div className="relative flex flex-col items-center origin-bottom">
           <div className="w-2 h-2 bg-yellow-400 rounded-full animate-ping mb-1 shadow-[0_0_10px_#facc15]"></div>
           {/* Sphere Body */}
           <div className="w-8 h-8 bg-yellow-500 rounded-full border-b-4 border-yellow-700 flex items-center justify-center">
             <div className="text-[8px] font-bold text-black">X</div>
           </div>
        </div>
      );
    }

    return (
      <div className="absolute z-15 transition-none" style={{ top: `${finalBuoyTop}%`, left: `${buoyState.x}%` }}>
         {BuoyShape}
         {/* Chain (Underwater) */}
         <div className="w-[2px] h-20 bg-black/20 mx-auto"></div>
      </div>
    );
  };

  const renderMarineScene = () => {
    const shipStart = 10; 
    const shipEnd = 85;
    const currentShipPos = shipStart + (visualProgress / 100) * (shipEnd - shipStart);
    
    const rigX = 5; 
    const stingerX = currentShipPos - 5;
    const stingerY = 60; 
    const touchdownX = Math.max(rigX, stingerX - 15);

    // BASE LEVELS
    const MSL = 45; 
    const currentWaterY = MSL - tideLevel;
    
    const shipBaseTop = currentWaterY - 10; 
    const finalShipTop = shipBaseTop + shipYOffset;

    return (
      <div className="w-full h-96 bg-slate-900/50 rounded-xl border border-white/10 relative overflow-hidden shadow-2xl backdrop-blur-sm group">
        
        {/* --- WEATHER BG (Z-0) --- */}
        <div className={`absolute inset-0 transition-all duration-2000 ${weather.bg}`}></div>
        <div className={`absolute inset-0 z-10 pointer-events-none transition-all duration-2000 ${weather.overlay}`}></div>
        
        {renderWeatherEffects()}

        {/* --- DISTANT RIG (Z-0) --- */}
        <div className="absolute bottom-[55%] left-[75%] opacity-40 scale-50 z-0">
           <div className="w-16 h-32 border-l-2 border-r-2 border-slate-500 relative flex flex-col justify-end">
              <div className="absolute inset-0 border-t border-b border-slate-600 opacity-50"></div>
              <div className="absolute top-0 w-24 -left-4 h-8 bg-slate-600 flex items-center justify-center">
                 <div className="w-1 h-6 bg-orange-500 absolute -top-6 left-2 animate-pulse"></div>
              </div>
           </div>
        </div>

        {/* --- DYNAMIC WAVE SURFACE (Z-10) --- */}
        <div className="absolute left-0 right-0 w-full h-full pointer-events-none z-10" style={{ top: `${currentWaterY}%` }}>
           <svg viewBox="0 0 100 50" preserveAspectRatio="none" className="w-full h-full overflow-visible">
             <path d={wavePath} className={`transition-colors duration-1000 ${weather.id === 'STORMY' ? 'fill-slate-800' : 'fill-cyan-900/80'}`} />
             <path d={wavePath.replace('L 100,50 L 0,50 Z', '')} fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="0.3" />
           </svg>
           {/* Deep Water Body */}
           <div className={`absolute top-[0%] left-0 w-full h-[200%] transition-colors duration-1000 ${weather.id === 'STORMY' ? 'bg-slate-900' : 'bg-cyan-900/80'} backdrop-blur-sm`}></div>
        </div>

        {/* --- SEABED (Z-20) --- */}
        <div className="absolute bottom-0 left-0 right-0 h-[10%] bg-[#0b0f19] border-t border-slate-800 z-20"></div>

        {/* --- PIPELINE SYSTEM (Z-25: Above Seabed) --- */}
        {/* Menggunakan z-25 agar di atas seabed (z-20), tapi pakai mask agar terlihat tertanam */}
        <svg className="absolute inset-0 w-full h-full z-25 pointer-events-none">
          <defs>
            <linearGradient id="pipeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stopColor="#78350f" />
              <stop offset="100%" stopColor="#d97706" />
            </linearGradient>
            <mask id="trenchMask">
              <rect x="0" y="0" width="100%" height="100%" fill="white" />
              <rect x="0" y="93%" width="100%" height="10%" fill="black" opacity="0.6" /> 
            </mask>
          </defs>

          <line x1={`${rigX}%`} y1="35%" x2={`${rigX}%`} y2="92%" stroke="#502005" strokeWidth="4" />
          <line x1={`${rigX}%`} y1="92%" x2={`${touchdownX}%`} y2="92%" stroke="url(#pipeGrad)" strokeWidth="4" strokeLinecap="round" mask="url(#trenchMask)"/>
          <path d={`M ${touchdownX}% 92% C ${touchdownX + 15}% 92%, ${stingerX - 10}% ${stingerY + 10}%, ${stingerX}% ${stingerY}%`} fill="none" stroke="#fbbf24" strokeWidth="3"/>
        </svg>

        {/* --- RIG A (Z-25) --- */}
        <div className="absolute bottom-[10%] left-[2%] w-20 h-40 z-25 opacity-90 flex flex-col items-center justify-end">
           <div className="w-16 h-32 border-l-4 border-r-4 border-slate-600 relative flex flex-col justify-between py-2 bg-slate-800/20">
              <div className="absolute inset-0 border-l border-r border-slate-600 skew-x-12 opacity-50"></div>
           </div>
           <div className="absolute top-0 w-24 h-12 bg-slate-700 border-2 border-slate-500 rounded-sm flex items-center justify-center shadow-lg">
              <div className="w-1 h-8 bg-red-500 absolute -top-8 left-4 animate-pulse"></div>
              <span className="text-[8px] font-bold text-slate-300">PLATFORM A</span>
           </div>
        </div>

        {/* --- BUOY (Z-15: Behind Ship) --- */}
        {renderBuoy()}

        {/* --- SHIP (Z-30: Topmost) --- */}
        <div 
          className="absolute w-64 h-32 z-30 transition-none" 
          style={{ 
            left: `calc(${currentShipPos}% - 12rem)`,
            top: `${finalShipTop}%` 
          }}
        >
           {selectedWorkDuration === 10 ? (
             <>
               <div className="absolute top-[45%] left-0 w-full h-12 bg-slate-200 border-b-4 border-slate-400 rounded-bl-[40px] shadow-xl z-20 flex items-center overflow-hidden transform skew-x-[-10deg]">
                  <div className="w-full h-2 bg-orange-500 absolute top-2"></div>
                  <div className="text-[7px] font-black text-slate-800 tracking-widest ml-12 mt-4 italic">TURBO LAYER</div>
               </div>
               <div className="absolute top-[20%] left-24 w-20 h-10 bg-slate-800 rounded-t-2xl z-10 skew-x-[-15deg] border-t-2 border-orange-500">
                  <div className="w-12 h-4 bg-cyan-400/50 absolute top-2 left-2 rounded-sm"></div>
               </div>
               <div className="absolute top-[55%] right-[95%] w-16 h-4 bg-orange-600 origin-top-right rotate-[15deg] rounded-l-full"></div>
             </>
           ) : selectedWorkDuration === 15 ? (
             <>
               <div className="absolute top-[42%] left-0 w-full h-14 bg-blue-800 border-b-4 border-blue-950 rounded-bl-3xl shadow-xl z-20 flex items-center justify-center overflow-hidden">
                  <div className="absolute top-4 w-full h-2 bg-white"></div>
                  <div className="text-[8px] font-bold text-white tracking-widest mt-6">EXPRESS LAY</div>
               </div>
               <div className="absolute top-[10%] left-10 w-20 h-20 bg-white border border-slate-300 rounded z-10 shadow-md flex flex-col p-1">
                  <div className="w-full h-4 bg-slate-800 rounded-sm mb-1"></div>
                  <div className="w-full h-4 bg-blue-900/30 rounded-sm"></div>
               </div>
               <div className="absolute top-[10%] right-10 w-8 h-24 bg-yellow-500 z-10 origin-bottom rotate-[-10deg]">
                  <div className="absolute top-0 w-12 h-2 bg-yellow-600 rotate-[90deg] origin-left"></div>
               </div>
               <div className="absolute top-[50%] right-[95%] w-20 h-16 border-t-4 border-l-4 border-yellow-600 rounded-tl-full bg-transparent transform rotate-12"></div>
             </>
           ) : (
             <>
               <div className="absolute top-[45%] right-[90%] w-24 h-24 overflow-hidden origin-top-right rotate-12 z-0">
                 <div className="w-32 h-20 border-t-4 border-l-4 border-red-700 rounded-tl-full bg-transparent transform rotate-12"></div>
               </div>
               <div className="absolute top-[40%] left-0 w-full h-16 bg-red-900 border-b-4 border-red-950 rounded-b-xl shadow-xl z-20 flex items-center justify-center overflow-hidden">
                  <div className="absolute top-2 w-full h-1 bg-yellow-400"></div>
                  <div className="text-[9px] font-black text-white/20 tracking-[0.5em] mt-4">HEAVY LIFT VESSEL</div>
               </div>
               <div className="absolute -top-[10%] right-8 w-16 h-32 z-10 origin-bottom flex flex-col items-center">
                  <div className="w-0 h-0 border-l-[20px] border-r-[20px] border-b-[80px] border-l-transparent border-r-transparent border-b-slate-700 relative">
                     <div className="absolute -top-4 w-[1px] h-32 bg-black/40"></div>
                  </div>
                  <div className="w-24 h-10 bg-slate-800 absolute bottom-0 rounded-t-lg border-t border-slate-600"></div>
               </div>
               <div className="absolute top-[35%] left-2 w-16 h-4 bg-green-700 border border-green-500 z-30 transform skew-x-12 shadow-md flex items-center justify-center">
                  <span className="text-[8px] font-bold text-white transform -skew-x-12">H</span>
               </div>
               <div className="absolute top-[15%] left-20 w-24 h-16 bg-white border border-slate-300 rounded-sm z-10 shadow-sm flex flex-col p-1 gap-1">
                  <div className="w-full h-3 bg-blue-900/20"></div>
                  <div className="w-full h-3 bg-blue-900/20"></div>
                  <div className="absolute -top-3 left-9 w-1 h-3 bg-slate-600"></div>
                  <div className="absolute -top-3 left-6 w-7 h-1 bg-slate-800 animate-spin"></div>
               </div>
             </>
           )}
           {isActive && (
             <div className="absolute top-[50%] right-[10%] z-30">
               <div className="w-2 h-2 bg-blue-200 rounded-full animate-ping shadow-[0_0_20px_blue]"></div>
             </div>
           )}
        </div>

        {/* --- RANDOM EVENTS (Z-35: In front of everything) --- */}
        {/* Police Boat (Z-35: In front of everything) */}
        {randomEvent === 'POLICE' && (
            <div className="absolute z-35 animate-patrol-boat" style={{ top: `${currentWaterY - 5 + shipYOffset}%` }}>
               <div className="w-24 h-8 bg-blue-800 rounded-br-2xl flex items-center justify-center relative shadow-lg">
                  <span className="text-[6px] text-white font-bold tracking-widest">POLICE</span>
                  <div className="absolute -top-2 left-6 w-8 h-4 bg-white rounded-t-lg"></div>
                  <div className="absolute -top-4 left-8 w-1 h-2 bg-red-500 animate-ping"></div>
                  <div className="absolute -top-4 left-10 w-1 h-2 bg-blue-500 animate-ping" style={{ animationDelay: '0.1s'}}></div>
               </div>
            </div>
        )}

      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-900 text-slate-200 font-sans overflow-hidden relative flex flex-col items-center selection:bg-amber-500/30">
      
      <div className="absolute inset-0 z-0 bg-gradient-to-br from-slate-900 via-slate-800 to-black"></div>

      <header className="w-full max-w-6xl z-40 p-6 flex justify-between items-center border-b border-white/5 bg-slate-900/80 backdrop-blur-md sticky top-0">
        <div className="flex items-center gap-4">
          <div className={`p-2 rounded border border-white/10 ${currentTheme === 'MARINE' ? 'bg-cyan-900/50 text-cyan-400' : 'bg-slate-800 text-slate-400'}`}>
            <Anchor />
          </div>
          <div>
            <h1 className="text-xl font-black tracking-widest uppercase text-white drop-shadow-md">OFFSHORE FOCUS <span className="text-amber-500 text-xs align-top">V6.3</span></h1>
            <span className="text-[10px] text-white/50 tracking-[0.2em] font-mono block">MARINE POMODORO</span>
          </div>
        </div>
        
        <div className="flex items-center gap-4">
          <div className="hidden md:flex items-center gap-2 text-xs font-mono text-cyan-400 bg-cyan-950/30 px-3 py-1 rounded border border-cyan-900/50">
            <Waves size={12} />
            <span>TIDE: {(tideLevel > 0 ? '+' : '')}{tideLevel.toFixed(1)}m</span>
          </div>
          <button onClick={() => setIsMenuOpen(true)} className="p-2 hover:bg-slate-800 rounded transition-colors text-white">
            <Menu />
          </button>
        </div>
      </header>

      {renderMenu()}

      <main className="flex-1 w-full max-w-6xl relative z-10 px-6 py-4 flex flex-col justify-center">
        
        {currentTheme === 'MARINE' ? renderMarineScene() : (
          <div className="w-full h-96 bg-slate-800 rounded-xl border border-white/10 flex items-center justify-center flex-col text-slate-500">
            <Hammer size={48} className="mb-4 opacity-50"/>
            <h2 className="text-xl font-bold">THEME: {currentTheme}</h2>
            <p>Work in Progress. Switch back to MARINE.</p>
          </div>
        )}

        <div className="w-full mt-8 grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
          <div className="flex flex-col pl-2">
             {mode === 'WORK' && !isActive && (
               <div className="flex gap-2 mb-4">
                 {DURATION_OPTIONS.map((opt) => (
                   <button
                     key={opt.id}
                     onClick={() => { setSelectedWorkDuration(opt.id); setTotalTime(opt.id*60); setTimeLeft(opt.id*60); }}
                     className={`flex items-center gap-2 px-4 py-2 text-[10px] font-bold rounded-full transition-all border ${
                       selectedWorkDuration === opt.id 
                         ? 'bg-amber-500 text-black border-amber-500 shadow-[0_0_15px_rgba(245,158,11,0.3)]' 
                         : 'bg-transparent text-slate-400 border-slate-700 hover:border-slate-500'
                     }`}
                   >
                     {selectedWorkDuration === opt.id && <Zap size={10} className="fill-current"/>}
                     {opt.label}
                   </button>
                 ))}
               </div>
             )}

             <div className={`text-xs font-bold tracking-widest px-4 py-1.5 rounded w-fit border mb-2 flex items-center gap-2 
               ${MODES[mode].color} border-current bg-white/5`}>
               {isActive ? <div className="w-2 h-2 rounded-full bg-current animate-pulse"/> : <Square size={10} />}
               {MODES[mode].label}
             </div>
             
             <div className="text-8xl font-black font-mono tracking-tighter text-white drop-shadow-2xl">
                {formatTime(timeLeft)}
             </div>
          </div>

          <div className="flex flex-col justify-center gap-4 h-full">
             <div className="flex gap-4 justify-end">
                {isActive ? (
                  <button 
                    onClick={toggleTimer}
                    className="flex-1 max-w-[200px] h-16 bg-rose-600 hover:bg-rose-500 text-white font-bold rounded-xl flex items-center justify-center gap-3 border-b-4 border-rose-900 active:border-b-0 active:translate-y-1 transition-all shadow-lg"
                  >
                    <Pause size={24} className="fill-current" /> PAUSE
                  </button>
                ) : (
                  <button 
                    onClick={toggleTimer}
                    className="flex-1 max-w-[200px] h-16 bg-amber-500 hover:bg-amber-400 text-black font-black rounded-xl flex items-center justify-center gap-3 border-b-4 border-amber-700 active:border-b-0 active:translate-y-1 transition-all shadow-lg"
                  >
                    <Play size={24} className="fill-current" /> 
                    {timeLeft < totalTime ? 'RESUME' : 'LAUNCH'}
                  </button>
                )}
                
                <button 
                  onClick={resetTimer}
                  className="w-16 h-16 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-xl flex items-center justify-center border-b-4 border-slate-950 active:border-b-0 active:translate-y-1 transition-all"
                >
                  <Square size={24} className="fill-current" />
                </button>
             </div>
          </div>
        </div>

      </main>

      <footer className="w-full bg-slate-950/50 border-t border-white/5 p-4 mt-auto z-40 backdrop-blur-md">
        <div className="max-w-6xl mx-auto flex items-start gap-4">
          <div className="bg-cyan-900/50 p-2 rounded-lg text-cyan-400 mt-1">
            <Search size={16} />
          </div>
          <div>
            <h3 className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-1">
              ENGINEERING DATABASE
            </h3>
            <p className="text-sm font-mono text-slate-300 leading-relaxed max-w-3xl">
              "{fact}"
            </p>
          </div>
        </div>
      </footer>

      <style dangerouslySetInnerHTML={{__html: `
        @keyframes slideDown {
          from { background-position: 0 0; }
          to { background-position: 0 100%; }
        }
        .animate-slide-down {
          animation: slideDown 1s linear infinite;
        }
        @keyframes lightning {
          0%, 90% { opacity: 0; }
          92% { opacity: 1; }
          94% { opacity: 0; }
          96% { opacity: 1; }
          100% { opacity: 0; }
        }
        .animate-lightning {
          animation: lightning 5s infinite;
        }
        @keyframes patrol-boat {
          0% { left: -100px; }
          100% { left: 110%; }
        }
        .animate-patrol-boat {
          animation: patrol-boat 25s linear forwards;
        }
      `}} />
    </div>
  );
}
